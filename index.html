<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apprenticeship Off-the-Job Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
    <!-- Load SheetJS for Excel reading/writing (MUST be loaded globally) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Load Chart.js for the Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <!-- Load Firebase CDN Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth, userId = null;
        let chartInstance = null; 
        let appId = null; 

        // CRITICAL FIX: A promise that resolves when Firebase and Auth are fully ready.
        let resolveDbReady;
        const dbReadyPromise = new Promise(resolve => { resolveDbReady = resolve; });

        // Use an object to hold state instead of global variables scattered
        const state = {
            logEntries: [],
            activeTab: 'logEntry',
            loading: true,
            error: null,
            importMessage: null,
            totalHoursNeeded: 0,
        };

        // Utility to display critical errors visually
        function displayCriticalError(message) {
             const appEl = document.getElementById('app');
             if (appEl) {
                 appEl.innerHTML = `
                    <header class="bg-red-600 text-white p-4">
                        <h1 class="text-2xl font-bold text-center">Apprenticeship Log</h1>
                    </header>
                    <div class="p-8 text-center bg-white rounded-b-xl">
                        <p class="text-red-600 font-bold mb-4">CRITICAL INITIALIZATION ERROR</p>
                        <p class="text-gray-700">${message}</p>
                        <p class="text-sm text-gray-500 mt-4">Please contact support or check the console for details.</p>
                    </div>
                 `;
             }
        }


        // --- Firebase Core Setup and Auth (Encapsulated) ---
        (async function initFirebase() {
            // --- MANDATORY FIREBASE CONFIGURATION USING GLOBAL VARIABLES ---
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig = null;
            
            try {
                // Check if the global variable exists and is a non-empty string before parsing
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                
                if (configString) {
                    firebaseConfig = JSON.parse(configString);
                } else {
                    throw new Error("The global Firebase configuration variable is missing or empty.");
                }
            } catch (e) {
                console.error("Firebase config parsing failed:", e);
                displayCriticalError("Firebase configuration is invalid or missing. The application cannot start.");
                // Prevent further execution if config is bad
                return; 
            }

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                displayCriticalError("Firebase configuration is missing the required API Key.");
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authenticate using the provided token or anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if no custom token is provided
                    await signInAnonymously(auth);
                }

                // 2. Set up the state change listener
                onAuthStateChanged(auth, async (user) => {
                    const userIdEl = document.getElementById('userIdDisplay');
                    
                    if (user) {
                        userId = user.uid;
                        if (userIdEl) userIdEl.textContent = `User ID: ${userId}`;
                        await getMetadata(); 
                        setupListeners();
                        // Resolve the promise, signaling readiness
                        resolveDbReady(true); 
                    } else {
                        userId = null;
                        if (userIdEl) userIdEl.textContent = `User ID: (Unauthenticated)`;
                        // Even unauthenticated, we resolve the promise to move the UI forward
                        resolveDbReady(false);
                    }
                    state.loading = false;
                    updateUI(); 
                });
                
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayCriticalError(`Firebase initialization failed during startup or authentication: ${e.message}`);
            }
        })();


        // --- Utility Functions ---
        
        function getCollectionPath() {
            return `artifacts/${appId}/users/${userId}/job_logs`;
        }
        
        function getMetadataDocRef() {
             return doc(db, `artifacts/${appId}/users/${userId}/metadata/app_config`);
        }
        
        async function saveMetadata(data) {
            if (!db || !userId) return; 
            try {
                await setDoc(getMetadataDocRef(), data, { merge: true });
            } catch (e) {
                console.error("Error saving metadata:", e);
                showNotification(`Failed to save metadata: ${e.message}`, true);
            }
        }
        
        async function getMetadata() {
            if (!db || !userId) return; 
            try {
                const docSnap = await getDoc(getMetadataDocRef());
                if (docSnap.exists()) {
                    state.totalHoursNeeded = docSnap.data().totalHoursNeeded || 0;
                }
            } catch (e) {
                console.error("Error fetching metadata:", e);
            }
        }

        function updateUI() {
            renderLogEntries();
            
            const logEntryView = document.getElementById('logEntryView');
            const importView = document.getElementById('importView');
            const summaryView = document.getElementById('summaryView');
            
            if (logEntryView) logEntryView.style.display = state.activeTab === 'logEntry' ? 'block' : 'none';
            if (importView) importView.style.display = state.activeTab === 'importData' ? 'block' : 'none';
            if (summaryView) summaryView.style.display = state.activeTab === 'summary' ? 'block' : 'none';

            // Tab highlighting
            const logEntryTab = document.getElementById('logEntryTab');
            const importTab = document.getElementById('importTab');
            const summaryTab = document.getElementById('summaryTab');
            
            if (logEntryTab) {
                logEntryTab.classList.toggle('border-blue-500', state.activeTab === 'logEntry');
                logEntryTab.classList.toggle('text-blue-600', state.activeTab === 'logEntry');
                logEntryTab.classList.toggle('border-transparent', state.activeTab !== 'logEntry');
            }
            if (importTab) {
                importTab.classList.toggle('border-blue-500', state.activeTab === 'importData');
                importTab.classList.toggle('text-blue-600', state.activeTab === 'importData');
                importTab.classList.toggle('border-transparent', state.activeTab !== 'importData');
            }
            if (summaryTab) {
                summaryTab.classList.toggle('border-blue-500', state.activeTab === 'summary');
                summaryTab.classList.toggle('text-blue-600', state.activeTab === 'summary');
                summaryTab.classList.toggle('border-transparent', state.activeTab !== 'summary');
            }


            // Render summary whenever state changes and tab is active
            if (state.activeTab === 'summary') {
                renderSummary();
            }
            
            const logStatus = document.getElementById('logStatus');
            if (logStatus) {
                if (state.error) {
                    logStatus.textContent = `Error: ${state.error}`;
                    logStatus.className = 'text-red-500 text-sm mt-2';
                } else if (state.importMessage) {
                    logStatus.textContent = state.importMessage;
                    logStatus.className = 'text-green-500 text-sm mt-2';
                } else {
                    logStatus.textContent = '';
                }
            }
        }
        
        function renderLogEntries() {
            const logList = document.getElementById('logList');
            if (!logList) return; 
            
            logList.innerHTML = '';
            
            if (state.loading) {
                 logList.innerHTML = '<p class="text-center p-4 text-gray-500">Loading log entries...</p>';
                 return;
            }

            if (state.logEntries.length === 0) {
                logList.innerHTML = '<p class="text-center p-4 text-gray-500">No log entries found. Add one or import a file!</p>';
                return;
            }

            // Reverse order so newest is on top
            state.logEntries.slice().reverse().forEach(entry => {
                // Ensure date is valid for display
                let displayDate = 'N/A';
                if (entry.date) {
                    displayDate = entry.date;
                } else if (entry.timestamp) {
                    displayDate = new Date(entry.timestamp).toLocaleDateString();
                } else if (entry.serverTimestamp && entry.serverTimestamp.toDate) {
                     displayDate = entry.serverTimestamp.toDate().toLocaleDateString();
                }

                const item = document.createElement('div');
                item.className = 'bg-white p-4 mb-3 rounded-lg border border-gray-100 card transition duration-300 hover:shadow-lg';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            <p class="text-lg font-semibold text-gray-800">${entry.description || 'No Description'}</p>
                            <p class="text-sm text-blue-600 font-medium">Job ID: ${entry.jobId || 'N/A'}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-green-600">${entry.offTheJobHours || 0}h</span>
                            <p class="text-xs text-gray-500">${displayDate}</p>
                        </div>
                    </div>
                `;
                logList.appendChild(item);
            });
        }
        
        function showNotification(message, isError = false) {
            state.error = isError ? message : null;
            state.importMessage = isError ? null : message;
            updateUI();
            setTimeout(() => {
                state.error = null;
                state.importMessage = null;
                updateUI();
            }, 5000);
        }

        /**
         * Calculates the number of working days (Mon-Fri) remaining in the current calendar year.
         * This calculation excludes weekends.
         * @returns {number} The number of working days remaining.
         */
        function calculateRemainingWorkingDays() {
            const today = new Date();
            const yearEnd = new Date(today.getFullYear(), 11, 31); // Dec 31st
            let workingDays = 0;
            let currentDate = new Date(today);

            while (currentDate <= yearEnd) {
                const day = currentDate.getDay();
                // Check if it's Monday (1) through Friday (5)
                if (day !== 0 && day !== 6) { 
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return workingDays;
        }

        // --- Summary Chart Rendering ---
        function renderSummary() {
            const chartCanvas = document.getElementById('progressChart');
            if (!chartCanvas) return; 

            const ctx = chartCanvas.getContext('2d');
            const currentYear = new Date().getFullYear();
            
            // 1. Total Apprenticeship Hours
            const totalHoursCompleted = state.logEntries.reduce((sum, entry) => sum + (entry.offTheJobHours || 0), 0);
            const totalNeeded = state.totalHoursNeeded > 0 ? state.totalHoursNeeded : 1100; 
            const hoursRemaining = Math.max(0, totalNeeded - totalHoursCompleted);
            
            // 2. Current Year Hours
            const currentYearHoursCompleted = state.logEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return !isNaN(entryDate) && entryDate.getFullYear() === currentYear;
            }).reduce((sum, entry) => sum + (entry.offTheJobHours || 0), 0);
            
            const remainingWorkingDays = calculateRemainingWorkingDays();


            // Update summary data display (Total Progress)
            const hoursCompletedEl = document.getElementById('hoursCompleted');
            const hoursRemainingEl = document.getElementById('hoursRemaining');
            const hoursTotalNeededEl = document.getElementById('hoursTotalNeeded');
            const progressPercentageEl = document.getElementById('progressPercentage');
            const currentYearHoursEl = document.getElementById('currentYearHours');
            const remainingWorkingDaysEl = document.getElementById('remainingWorkingDays');
            
            if (hoursCompletedEl) hoursCompletedEl.textContent = totalHoursCompleted.toFixed(1);
            if (hoursRemainingEl) hoursRemainingEl.textContent = hoursRemaining.toFixed(1);
            if (hoursTotalNeededEl) hoursTotalNeededEl.textContent = totalNeeded.toFixed(1);
            
            const progressPercentage = (totalHoursCompleted / totalNeeded) * 100;
            if (progressPercentageEl) progressPercentageEl.textContent = progressPercentage.toFixed(1);
            
            // Update summary data display (Yearly Context)
            if (currentYearHoursEl) currentYearHoursEl.textContent = currentYearHoursCompleted.toFixed(1);
            if (remainingWorkingDaysEl) remainingWorkingDaysEl.textContent = remainingWorkingDays;


            // Destroy existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Hours Completed', 'Hours Remaining'],
                    datasets: [{
                        label: 'Apprenticeship Progress',
                        data: [totalHoursCompleted, hoursRemaining],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)', // Green-500
                            'rgba(59, 130, 246, 0.8)'  // Blue-500
                        ],
                        borderColor: [
                            'rgba(255, 255, 255, 1)',
                            'rgba(255, 255, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Total Apprenticeship Hour Progress',
                            font: {
                                size: 18
                            }
                        }
                    }
                }
            });
        }

        // --- Firestore Data Listeners ---
        function setupListeners() {
            if (!db || !userId) return;
            
            const q = query(collection(db, getCollectionPath()), orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const dateString = data.date || (data.timestamp ? new Date(data.timestamp).toLocaleDateString() : 'N/A');
                    logs.push({ id: doc.id, date: dateString, ...data });
                });
                state.logEntries = logs;
                state.loading = false;
                updateUI();
            }, (error) => {
                console.error("Error fetching logs:", error);
                showNotification(`Data Fetch Error: ${error.message}`, true);
                state.loading = false;
                updateUI();
            });
        }
        
        /**
         * Converts log entry data into a spreadsheet format and triggers a download.
         */
        window.handleExport = function() {
            if (state.logEntries.length === 0) {
                showNotification("No data to export.", true);
                return;
            }

            const headers = [
                "Date", 
                "Activity Description", 
                "Job ID", 
                "Off-the-Job Hours"
            ];

            const exportData = state.logEntries.map(entry => ({
                "Date": entry.date,
                "Activity Description": entry.description,
                "Job ID": entry.jobId,
                "Off-the-Job Hours": entry.offTheJobHours,
            }));

            const ws = XLSX.utils.json_to_sheet(exportData, { header: headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Off-the-Job Log");

            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `Apprenticeship_Log_${today}.xlsx`);
            
            showNotification("Data exported successfully!");
        }

        // --- Event Handlers & Logic ---
        
        window.switchTab = function(tabName) {
            state.activeTab = tabName;
            updateUI();
        }

        window.addJobLog = async function(event) {
            event.preventDefault();
            // Wait for authentication before proceeding
            await dbReadyPromise;
            
            if (!db || !userId) {
                showNotification("Authentication failed. Please wait for initialization.", true);
                return;
            }

            const form = event.target;
            const dateValue = form.date.value;
            
            const newLog = {
                jobId: form.jobId.value.trim() || 'N/A',
                description: form.description.value.trim(),
                offTheJobHours: parseFloat(form.hours.value) || 0,
                date: dateValue,
                timestamp: new Date(dateValue).getTime(),
                serverTimestamp: serverTimestamp()
            };
            
            if (!newLog.description || !newLog.offTheJobHours || !newLog.date) {
                showNotification("Please fill in Description, Hours, and Date.", true);
                return;
            }
            
            try {
                await addDoc(collection(db, getCollectionPath()), newLog);
                form.reset();
                showNotification("Log entry added successfully!");
            } catch (e) {
                console.error("Error adding document: ", e);
                showNotification(`Failed to add log: ${e.message}`, true);
            }
        }
        
        window.handleImport = async function() {
            // CRITICAL FIX: Ensure Firebase is ready before doing anything that requires the database/userId
            await dbReadyPromise;

            if (typeof XLSX === 'undefined') {
                showNotification("Excel library not loaded. Cannot process file.", true);
                return;
            }

            if (!db || !userId) {
                showNotification("Import failed: User not authenticated. Please wait for initialization.", true);
                return;
            }
            
            const fileInput = document.getElementById('excelFile');
            if (fileInput.files.length === 0) {
                showNotification("Please select an Excel file (.xlsx or .xls) to import.", true);
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            document.getElementById('importButton').disabled = true;
            document.getElementById('importButton').textContent = 'Processing...';

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    
                    // Parse the Excel file.
                    // dateNF: "YYYY-MM-DD" is crucial for date reading
                    const workbook = XLSX.read(data, { type: 'array', dateNF: "YYYY-MM-DD" }); 
                    const sheetName = workbook.SheetNames[0]; 
                    const worksheet = workbook.Sheets[sheetName];

                    // raw: false is crucial for date formatting
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: "YYYY-MM-DD" }); 
                    
                    if (json.length < 2) {
                        showNotification("Import failed: Excel sheet is empty or has no data rows.", true);
                        return;
                    }

                    // --- DEBUG STEP 1: Log the raw JSON structure ---
                    console.log("--- DEBUG START: Raw JSON from Excel (Top 10 rows) ---");
                    console.log(json.slice(0, 10));
                    console.log("-----------------------------------------------------");
                    
                    let headerRowIndex = -1;
                    
                    // Keys we are looking for (case-insensitive)
                    const SEARCH_KEYS = {
                        date: ['date'],
                        desc: ['activity description', 'description', 'activity'], // Added a more flexible description search
                        hours: ['hours', 'hr', 'off-the-job hours', 'otj hours'],
                        agreedHrs: ['agreed hrs', 'agreedhrs', 'total otj required', 'total otj hours', 'totalhrs', 'calculated minimum hrs', '360 hrs needed'] // Consolidated keys
                    };

                    // Function to normalize a cell value for comparison
                    const normalizeCell = (cell) => String(cell || '').trim().toLowerCase().replace(/[^a-z0-9]/g, '');

                    // Find the actual header row (row containing 'Date' and 'Hours')
                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        const rowKeys = row.map(normalizeCell);
                        
                        // Check if row contains a Date key AND an Hours key
                        const hasDate = rowKeys.some(key => SEARCH_KEYS.date.some(sk => key.includes(sk)));
                        const hasHours = rowKeys.some(key => SEARCH_KEYS.hours.some(sk => key.includes(sk)));
                        
                        if (hasDate && hasHours) {
                            headerRowIndex = i;
                            // --- DEBUG STEP 2: Log the detected header row index and content ---
                            console.log(`--- DEBUG: Header Row Detected at Index: ${headerRowIndex} ---`);
                            console.log(row);
                            console.log("-----------------------------------------------------");
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                         showNotification("Import failed: Could not find the required header row ('Date' and 'Hours').", true);
                         return;
                    }
                    
                    // 2. Extract Total Agreed Hours from Metadata Rows (Before header)
                    let totalHoursNeeded = 0;
                    
                    for (let i = 0; i < headerRowIndex; i++) {
                        const row = json[i];
                        
                        for (let j = 0; j < row.length; j++) {
                            const cellValue = normalizeCell(row[j]);
                            
                            if (SEARCH_KEYS.agreedHrs.some(key => cellValue.includes(key))) {
                                // Look for the number immediately following the keyword in the same row
                                for (let k = j + 1; k < row.length; k++) {
                                    // Robust parsing for numbers
                                    const valueCandidate = String(row[k] || '').trim().replace(/[^\d.]/g, ''); 
                                    const parsedValue = parseFloat(valueCandidate);
                                    
                                    if (!isNaN(parsedValue) && parsedValue > 0) {
                                        totalHoursNeeded = parsedValue;
                                        break;
                                    }
                                }
                                if (totalHoursNeeded > 0) break; 
                            }
                        }
                        if (totalHoursNeeded > 0) break;
                    }

                    // --- DEBUG STEP 3: Log the extracted total hours needed ---
                    console.log(`--- DEBUG: Extracted Total Hours Needed: ${totalHoursNeeded} ---`);
                    
                    if (totalHoursNeeded > 0) {
                        await saveMetadata({ totalHoursNeeded });
                        state.totalHoursNeeded = totalHoursNeeded;
                    } else {
                        console.warn("Could not find 'Agreed Hrs' metadata value in the spreadsheet header area. Using default/existing value.");
                    }
                    
                    // 3. Process job log data
                    const headers = json[headerRowIndex];
                    let dateCol = -1, descCol = -1, hoursCol = -1, jobIdCol = -1; 
                    
                    // Identify column indices based on normalized headers
                    headers.forEach((header, index) => {
                        const normalizedHeader = normalizeCell(header);
                        if (SEARCH_KEYS.date.some(key => normalizedHeader.includes(key))) {
                            dateCol = index;
                        } else if (SEARCH_KEYS.desc.some(key => normalizedHeader.includes(key))) {
                            descCol = index;
                        } else if (SEARCH_KEYS.hours.some(key => normalizedHeader.includes(key))) {
                            hoursCol = index;
                        } else if (normalizedHeader.includes('jobid') || normalizedHeader.includes('projectid')) { 
                            jobIdCol = index;
                        }
                    });

                    // --- DEBUG STEP 4: Log the identified column indices ---
                    console.log(`--- DEBUG: Column Indices ---`);
                    console.log(`Date Col: ${dateCol}, Description Col: ${descCol}, Hours Col: ${hoursCol}, Job ID Col: ${jobIdCol}`);
                    console.log("-------------------------------");
                    
                    if (dateCol === -1 || descCol === -1 || hoursCol === -1) {
                        showNotification("Import failed: Could not map 'Date', 'Activity Description', and 'Hours' columns in the header row.", true);
                        return;
                    }
                    
                    let jobData = [];
                    for (let i = headerRowIndex + 1; i < json.length; i++) {
                        const row = json[i];
                        
                        if (row.length === 0 || (!row[dateCol] && !row[descCol] && !row[hoursCol])) {
                            continue;
                        }

                        // Use String(value || '').trim() for safety
                        const date = row[dateCol] ? String(row[dateCol]).trim() : '';
                        const description = row[descCol] ? String(row[descCol]).trim() : '';
                        
                        // Robustly parse the hours, replacing commas with periods and removing non-numeric characters
                        const hoursStr = row[hoursCol] ? String(row[hoursCol]).trim().replace(',', '.') : '0';
                        const hours = parseFloat(hoursStr.replace(/[^\d.]/g, '')) || 0;
                        
                        const jobId = jobIdCol !== -1 && row[jobIdCol] ? String(row[jobIdCol]).trim() : 'N/A';
                        
                        jobData.push({ date, description, hours, jobId });
                    }
                    
                    // --- DEBUG STEP 5: Log the first few parsed entries ---
                    console.log("--- DEBUG: First 5 Parsed Log Entries ---");
                    console.log(jobData.slice(0, 5));
                    console.log("-----------------------------------------");

                    let successCount = 0;
                    let failureCount = 0;
                    
                    // 4. Upload to Firestore
                    for (const item of jobData) {
                        const description = item.description;
                        const hours = item.hours;
                        const date = item.date;

                        if (description && hours > 0 && date && Date.parse(date)) {
                            try {
                                const logEntry = {
                                    jobId: item.jobId,
                                    description: description,
                                    offTheJobHours: hours,
                                    date: date, 
                                    timestamp: new Date(date).getTime(), 
                                    serverTimestamp: serverTimestamp()
                                };
                                await addDoc(collection(db, getCollectionPath()), logEntry);
                                successCount++;
                            } catch (e) {
                                console.error("Error importing document: ", e);
                                failureCount++;
                            }
                        } else {
                            // Only count as a failure if it had some data but was invalid
                            if (description || hours > 0 || date) {
                                failureCount++;
                            }
                        }
                    }
                    
                    showNotification(`Import Complete: ${successCount} entries added, ${failureCount} entries skipped (missing required data or bad format).`);
                    window.switchTab('summary'); 

                } catch (e) {
                    console.error("Error processing Excel file:", e);
                    showNotification(`Import Error: Could not process file. Ensure it is a valid Excel file and the first sheet contains data. (${e.message})`, true);
                } finally {
                    document.getElementById('importButton').disabled = false;
                    document.getElementById('importButton').textContent = 'Start Import';
                    fileInput.value = ''; 
                }
            };

            reader.onerror = () => {
                showNotification("Error reading file.", true);
                document.getElementById('importButton').disabled = false;
                document.getElementById('importButton').textContent = 'Start Import';
            };

            reader.readAsArrayBuffer(file);
        }

        // Initialize UI with initial state
        document.addEventListener('DOMContentLoaded', updateUI);

    </script>
</head>
<body class="p-0 sm:p-4 bg-gray-50 min-h-screen">

    <div id="app" class="max-w-xl mx-auto bg-white sm:rounded-xl shadow-lg overflow-hidden">
        
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4">
            <h1 class="text-2xl font-bold text-center">Apprenticeship Log</h1>
            <p id="userIdDisplay" class="text-xs text-center opacity-75 mt-1">Authenticating...</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200">
            <button id="logEntryTab" onclick="switchTab('logEntry')" 
                    class="flex-1 py-3 text-center text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">
                Log New Entry
            </button>
            <button id="importTab" onclick="switchTab('importData')" 
                    class="flex-1 py-3 text-center text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">
                Import Data
            </button>
            <button id="summaryTab" onclick="switchTab('summary')" 
                    class="flex-1 py-3 text-center text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">
                Summary
            </button>
        </div>

        <div id="logStatus" class="p-3 text-center font-medium"></div>

        <!-- Main Content Area -->
        <div class="p-6 bg-gray-50 min-h-[400px]">

            <!-- 1. Log New Entry View -->
            <div id="logEntryView">
                <div class="mb-6 card rounded-lg p-4 bg-white border border-gray-100">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">Add New Off-the-Job Activity</h2>
                    <form onsubmit="addJobLog(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="date" name="date" required 
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="hours" class="block text-sm font-medium text-gray-700 mb-1">Hours Spent (OTJ)</label>
                                <input type="number" id="hours" name="hours" step="0.1" min="0" required 
                                    placeholder="e.g., 3.5"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="jobId" class="block text-sm font-medium text-gray-700 mb-1">Job/Project ID (Optional)</label>
                                <input type="text" id="jobId" name="jobId" 
                                    placeholder="e.g., 1001"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Activity Description</label>
                                <textarea id="description" name="description" rows="3" required 
                                    placeholder="A summary of the off-the-job activity, e.g., 'Classroom training on brake systems' or 'Self-study of diagnostic procedures.'"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="w-full mt-6 py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150">
                            Add Log Entry
                        </button>
                    </form>
                </div>
                
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Recent Activity</h2>
                <div id="logList" class="space-y-3">
                    <!-- Log entries will be rendered here -->
                </div>
                
                <button onclick="handleExport()" class="w-full mt-6 py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150">
                    Export All Data to Excel
                </button>
            </div>

            <!-- 2. Import Data View -->
            <div id="importView" style="display:none;">
                <div class="card rounded-lg p-6 bg-white border border-gray-100">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Import from Excel</h2>
                    <p class="text-sm text-gray-500 mb-4">Upload your existing off-the-job log file (.xlsx or .xls). The importer will automatically detect the **Date**, **Activity Description**, and **Hours** columns.</p>
                    
                    <input type="file" id="excelFile" accept=".xlsx, .xls" class="w-full mb-6 text-sm text-gray-700
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100
                    "/>
                    
                    <button id="importButton" onclick="handleImport()" 
                        class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150">
                        Start Import
                    </button>
                    
                    <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-800 rounded">
                        <p class="font-bold">Note:</p>
                        <p>If your spreadsheet contains a cell labeled **'Agreed Hrs'** (or similar, e.g., 'Total OTJ Required'), the importer will attempt to automatically set your total required hours in the Summary tab.</p>
                    </div>
                </div>
            </div>

            <!-- 3. Summary View -->
            <div id="summaryView" style="display:none;">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Apprenticeship Progress Summary</h2>

                <!-- Main Progress Card -->
                <div class="card rounded-xl p-5 mb-6 bg-blue-50 border border-blue-200">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-medium text-blue-800">Total Progress</p>
                        <span id="progressPercentage" class="text-3xl font-extrabold text-blue-600">0.0</span><span class="text-lg text-blue-600">%</span>
                    </div>
                    <div class="flex justify-around text-center">
                        <div>
                            <p id="hoursCompleted" class="text-3xl font-bold text-green-600">0</p>
                            <p class="text-sm text-gray-600">Completed</p>
                        </div>
                        <div>
                            <p id="hoursRemaining" class="text-3xl font-bold text-red-600">1100</p>
                            <p class="text-sm text-gray-600">Remaining</p>
                        </div>
                        <div>
                            <p id="hoursTotalNeeded" class="text-3xl font-bold text-gray-700">1100</p>
                            <p class="text-sm text-gray-600">Total Target</p>
                        </div>
                    </div>
                </div>

                <!-- Chart Canvas -->
                <div class="bg-white p-4 rounded-xl card mb-6 border border-gray-100">
                    <canvas id="progressChart"></canvas>
                </div>
                
                <!-- Yearly Context Card -->
                 <div class="card rounded-xl p-5 bg-white border border-gray-100">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Yearly Context (${new Date().getFullYear()})</h3>
                    <div class="space-y-2">
                         <p class="flex justify-between text-gray-600">
                            <span>Hours Logged This Year:</span>
                            <span id="currentYearHours" class="font-bold text-green-600">0.0</span>
                        </p>
                        <p class="flex justify-between text-gray-600 border-t pt-2 border-gray-100">
                            <span>Working Days Left in Year:</span>
                            <span id="remainingWorkingDays" class="font-bold text-blue-600">0</span>
                        </p>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
</body>
</html>
